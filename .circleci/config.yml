# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

orbs:
  node: circleci/node@5.0.2  # for using yarn cache automatically  
# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  build_with_node:
    docker:
      - image: 'cimg/node:16.15.0'  # can use executor by node orbs or we can set manually
    steps:
      - checkout
      - run: echo "Build started on `date`"                     
      - node/install-packages:
          check-cache: detect # try using yarn.lock
      - run: yarn run build 
      - persist_to_workspace:
          # Must be an absolute path, or relative path from working_directory. This is a directory on the container which is
          # taken to be the root directory of the workspace.
          root: out
          # Must be relative path from root
          paths: .            
  docs_deploy:
    docker:
      - image: 'cimg/node:16.15.0'
    steps:
      - checkout
      - attach_workspace:
          at: out
      - run:
          name: Install and configure dependencies
          command: |
            npm install -g --silent gh-pages@2.0.1
            git config user.email "rio@fivejack.com"
            git config user.name "Rionardo"
      - add_ssh_keys:
          fingerprints:
            - "79:01:84:8e:7f:53:63:bc:c6:8e:48:3a:cd:d1:60:f3"
      - run:
          name: Deploy docs to gh-pages branch
          command: gh-pages --dotfiles --message "[skip ci] Updates" --dist out
# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  build_push_docs_workflow:
    jobs:
      - approve_build: # manual approval          
          type: approval 
      - build_with_node : # build started
          requires:
            - approve_build
      - docs_deploy: # manual approval          
          requires:
            - build_with_node
